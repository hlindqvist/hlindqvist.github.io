<!DOCTYPE html>
<html class="direction--ltr"lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>PowerDNS Recursor RPZ with cacheable results | hlindqvist</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="PowerDNS Recursor RPZ with cacheable results" />
<meta name="author" content="Håkan Lindqvist" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="RPZ is a standardized and fairly convenient way of distributing and applying blocklists in standard nameserver software. For instance, you may have lists with domains used for malware, tracking, ads, etc, to block, much like specialized nameserver software such as PiHole does." />
<meta property="og:description" content="RPZ is a standardized and fairly convenient way of distributing and applying blocklists in standard nameserver software. For instance, you may have lists with domains used for malware, tracking, ads, etc, to block, much like specialized nameserver software such as PiHole does." />
<link rel="canonical" href="https://hakanlindqvist.com/2022/12/26/powerdns-recursor-rpz.html" />
<meta property="og:url" content="https://hakanlindqvist.com/2022/12/26/powerdns-recursor-rpz.html" />
<meta property="og:site_name" content="hlindqvist" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-26T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PowerDNS Recursor RPZ with cacheable results" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Håkan Lindqvist"},"dateModified":"2022-12-26T00:00:00+00:00","datePublished":"2022-12-26T00:00:00+00:00","description":"RPZ is a standardized and fairly convenient way of distributing and applying blocklists in standard nameserver software. For instance, you may have lists with domains used for malware, tracking, ads, etc, to block, much like specialized nameserver software such as PiHole does.","headline":"PowerDNS Recursor RPZ with cacheable results","mainEntityOfPage":{"@type":"WebPage","@id":"https://hakanlindqvist.com/2022/12/26/powerdns-recursor-rpz.html"},"url":"https://hakanlindqvist.com/2022/12/26/powerdns-recursor-rpz.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/assets/css/magnific-popup.css"><link type="application/atom+xml" rel="alternate" href="https://hakanlindqvist.com/feed.xml" title="hlindqvist" /><script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
  <script src="/assets/js/jquery.magnific-popup.js"></script>
</head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">hlindqvist<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        
        
        <a class="color-purple-hover" href="https://noc.social/@hlindqvist" rel="me"><i class="fab fa-mastodon"></i></a>
        
        
        
        <a class="color-indigo-hover" href="https://github.com/hlindqvist" rel="me"><i class="fab fa-github"></i></a>
        
        
        
        <a class="color-cyan-hover" href="https://twitter.com/HakanLindqvist"><i class="fab fa-twitter"></i></a>
        
        
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">


<img src="
    https://github.com/hlindqvist.png
" class="author-avatar" alt="Avatar" />
<div class="description">Håkan is a software engineer and DNS fanatic from Sweden. He occasionally blogs about software, networking and related topics.
</div>

</div>


<div class="post">
  <h1 class="post-title">PowerDNS Recursor RPZ with cacheable results</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/dns/">dns</a>
      
      <a class="tag" href="/tag/powerdns/">powerdns</a>
      
      <a class="tag" href="/tag/powerdns-recursor/">powerdns-recursor</a>
      
      <a class="tag" href="/tag/rpz/">rpz</a>
      
  </div>
  
  <div class="post-date">
    Published on 26 Dec 2022
    
  </div>
  
  <p>RPZ is a standardized and fairly convenient way of distributing and applying blocklists in standard nameserver software.
For instance, you may have lists with domains used for malware, tracking, ads, etc, to block, much like specialized
nameserver software such as PiHole does.</p>

<p>Blocking names in DNS is not unproblematic, it is not a fool-proof way of blocking badness, it does not play nice
with DNSSEC (however, the goal is to block, so even triggering a validation failure achieves the end goal), and can be used in abusive ways.<br />
All that said, it can still certainly serve a purpose as a relatively unintrusive yet convenient layer of protection, and as long as it is used as a means of empowering the user, I at least don’t see an ethical problem.</p>

<p>Setting up <a href="https://doc.powerdns.com/recursor/lua-config/rpz.html#configuring-rpz">RPZ in PowerDNS Recursor</a> is pretty straightforward through its Lua-based configuration. See the below example:</p>

<p>recursor.conf:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lua-config-file=/etc/powerdns/recursor.lua
lua-dns-script=/etc/powerdns/dns.lua
extended-resolution-errors=yes
</code></pre></div></div>

<p>recursor.lua:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">rpz_zones</span><span class="o">=</span><span class="p">{</span> <span class="s2">"adblocknocoin.hoshsadiq.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"adguard.firebog.rpz.qw.se"</span><span class="p">,</span>
<span class="s2">"adservers.anudeepnd.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"easyprivacy.firebog.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"hole.certpl.rpz.qw.se"</span><span class="p">,</span>
<span class="s2">"hosts.stevenblack.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"kadhosts.stevenblack.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"notrack-blocklist.quidsup.rpz.qw.se"</span><span class="p">,</span>
<span class="s2">"pgl.yoyo.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"prigent-malware.firebog.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"rpilist-malware.firebog.rpz.qw.se"</span><span class="p">,</span>
<span class="s2">"rpilist-phishing.firebog.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"rpz.oisd.nl.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"simplead.disconnectme.rpz.qw.se"</span><span class="p">,</span>
<span class="s2">"simpletracking.disconnectme.rpz.qw.se"</span><span class="p">,</span> <span class="s2">"urlhaus.abusech.rpz.qw.se"</span> <span class="p">}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">rpz_zones</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">rpzPrimary</span><span class="p">({</span> <span class="s2">"139.162.158.28"</span><span class="p">,</span> <span class="s2">"2a01:7e01::f03c:91ff:fee4:c68b"</span> <span class="p">},</span> <span class="n">v</span><span class="p">,</span> <span class="p">{</span> <span class="n">extendedErrorCode</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
<span class="n">extendedErrorExtra</span> <span class="o">=</span> <span class="s2">"Blocked by policy "</span> <span class="o">..</span> <span class="n">v</span><span class="p">,</span> <span class="n">dumpFile</span> <span class="o">=</span> <span class="s2">"/tmp/db."</span> <span class="o">..</span> <span class="n">v</span><span class="p">,</span> <span class="n">seedFile</span> <span class="o">=</span> <span class="s2">"/tmp/db."</span> <span class="o">..</span> <span class="n">v</span><span class="p">,</span>
<span class="n">axfrTimeout</span><span class="o">=</span><span class="mi">60</span> <span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This defines a list of RPZ zones to <code class="language-plaintext highlighter-rouge">AXFR</code>/<code class="language-plaintext highlighter-rouge">IXFR</code> from a server hosting some such zones, also defining an
extended error code to include in responses for blocked names.</p>

<p>What you will find, however, is that when PowerDNS Recursor applies an RPZ policy, it responds with empty <code class="language-plaintext highlighter-rouge">NXDOMAIN</code> messages (no <code class="language-plaintext highlighter-rouge">SOA</code>), while negative caching is done precisely based on the <code class="language-plaintext highlighter-rouge">SOA</code> record supposedly found in the <code class="language-plaintext highlighter-rouge">AUTHORITY</code> section of negative responses.<br />
This makes for uncacheable responses (or at least with no control at all over any caching behavior that may exist), however, one can use the <a href="https://doc.powerdns.com/recursor/lua-scripting/hooks.html">Lua hooks for changing responses</a> to add a made-up <code class="language-plaintext highlighter-rouge">SOA</code> record that at least allows for specifying a TTL to control cache behavior.</p>

<p>dns.lua:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">nxdomain</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixrpz</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">nodata</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixrpz</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">fixrpz</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dq</span><span class="p">.</span><span class="n">appliedPolicy</span><span class="p">.</span><span class="n">policyKind</span> <span class="o">==</span> <span class="n">pdns</span><span class="p">.</span><span class="n">policykinds</span><span class="p">.</span><span class="n">NODATA</span> <span class="ow">or</span> <span class="n">dq</span><span class="p">.</span><span class="n">appliedPolicy</span><span class="p">.</span><span class="n">policyKind</span> <span class="o">==</span>
<span class="n">pdns</span><span class="p">.</span><span class="n">policykinds</span><span class="p">.</span><span class="n">NXDOMAIN</span> <span class="k">then</span>
        <span class="n">pdnslog</span><span class="p">(</span><span class="s2">"Intercepting RPZ NODATA/NXDOMAIN for: "</span><span class="o">..</span><span class="n">dq</span><span class="p">.</span><span class="n">qname</span><span class="p">:</span><span class="n">toString</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">dq</span><span class="p">.</span><span class="n">appliedPolicy</span><span class="p">.</span><span class="n">policyKind</span> <span class="o">==</span> <span class="n">pdns</span><span class="p">.</span><span class="n">policykinds</span><span class="p">.</span><span class="n">NODATA</span> <span class="k">then</span>
            <span class="n">dq</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">pdns</span><span class="p">.</span><span class="n">NOERROR</span>
        <span class="k">else</span>
            <span class="n">dq</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">pdns</span><span class="p">.</span><span class="n">NXDOMAIN</span>
        <span class="k">end</span>
        <span class="n">dq</span><span class="p">:</span><span class="n">addRecord</span><span class="p">(</span><span class="n">pdns</span><span class="p">.</span><span class="n">SOA</span><span class="p">,</span> <span class="s2">"blocked.invalid. blocked.invalid. 1 1 1 1 600"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="c1">-- 2 = AUTHORITY - https://docs.powerdns.com/recursor/lua-scripting/dnsrecord.html#DNSRecord.place</span>

        <span class="n">dq</span><span class="p">.</span><span class="n">appliedPolicy</span><span class="p">.</span><span class="n">policyKind</span> <span class="o">=</span> <span class="n">pdns</span><span class="p">.</span><span class="n">policykinds</span><span class="p">.</span><span class="n">NoAction</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This overrides <code class="language-plaintext highlighter-rouge">NXDOMAIN</code>/<code class="language-plaintext highlighter-rouge">NODATA</code> responses that were introduced by RPZ so that they include an <code class="language-plaintext highlighter-rouge">SOA</code> record.</p>

</div>








  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/dns/" class="set-5">dns</a> <a href="/tag/powerdns/" class="set-5">powerdns</a> <a href="/tag/powerdns-recursor/" class="set-5">powerdns-recursor</a> <a href="/tag/rpz/" class="set-5">rpz</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();

  // Image modal
  var $imgs = [];
  $('img').each(function(idx) {
    var obj = {
      src: $(this).attr('src')
    }
    $imgs.push(obj);
    var elem = $(this);
    $(this).click(function() {
      $('.modal').magnificPopup('open', idx);
    });
  });

  $('.modal').magnificPopup({
    items: $imgs,
    type: 'image',
    closeOnContentClick: true,
    mainClass: 'mfp-img-mobile',
    image: {
      verticalFit: true
    }
    
  });
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><a href="https://github.com/bitbrain/jekyll-dash">dash</a> theme for Jekyll by <a href="https://github.com/bitbrain">bitbrain</a> made with <i class="fas fa-heart"></i><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
